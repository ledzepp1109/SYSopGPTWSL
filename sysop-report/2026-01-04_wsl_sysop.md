# WSL Sysop Report (Safe Tier A Applied)

Date: 2026-01-04

Scope: Implemented tier **A1–A3 only** (safe defaults). No installs, no sudo, no network calls, and no B/C items applied.

## A1 — Idempotent npm-global PATH export (dedupe-safe)

Goal: ensure `~/.npm-global/bin` is on `PATH` exactly once, including in nested shells and `bash -lc` (login shells).

Edits:
- `~/.profile`: add an idempotent + de-duplicating `PATH` snippet for `~/.npm-global/bin`.
- `~/.bashrc`: replace the unguarded `export PATH="$HOME/.npm-global/bin:$PATH"` with the same de-duplicating snippet.

Backups created (timestamped, next to the files):
- `~/.profile.bak-20260104-084950`
- `~/.bashrc.bak-20260104-084950`
- `~/.profile.bak-20260104-085113`
- `~/.bashrc.bak-20260104-085113`
- `~/.profile.bak-20260104-085207`
- `~/.bashrc.bak-20260104-085207`

Rollback (pick one matching how far back you want to revert):
- Revert **all** changes from this run (restore original pre-A1 state):
  - `cp -a ~/.profile.bak-20260104-084950 ~/.profile`
  - `cp -a ~/.bashrc.bak-20260104-084950 ~/.bashrc`
- Revert **only the last edit** (restore to state after first A1 insertion, before dedupe refinement):
  - `cp -a ~/.profile.bak-20260104-085207 ~/.profile`
  - `cp -a ~/.bashrc.bak-20260104-085207 ~/.bashrc`

Verification (fresh login shell):
```sh
bash -lc 'command -v codex; codex --version; npm prefix -g; echo $PATH | tr ":" "\n" | grep -n "\.npm-global/bin"'
```
Observed output:
```
/home/xhott/.npm-global/bin/codex
codex-cli 0.77.0
/home/xhott/.npm-global
1:/home/xhott/.npm-global/bin
```

## A2 — `~/sysop/preflight.sh` (read-only checks)

Created: `~/sysop/preflight.sh` (executable).

Behavior:
- Read-only, prints clear `PASS/WARN/FAIL` lines.
- Checks: WSL detection, `/mnt` usage warning, `codex` availability, npm prefix, `PATH` duplication for `~/.npm-global/bin`, basic node/python presence, and git cleanliness when inside a repo.

Run:
```sh
~/sysop/preflight.sh
```

## A3 — `~/sysop/healthcheck.sh` (read-only audit runner)

Created: `~/sysop/healthcheck.sh` (executable).

Behavior:
- Read-only, runs a compact environment audit similar to Phase 1 (OS/WSL/mounts/toolchain/git/ssh/resources/systemd/dbus).

Run:
```sh
~/sysop/healthcheck.sh
```

## Operator Note — systemd bus issue (not changed here)

Symptom observed earlier:
- `systemd` is PID 1, `dbus-daemon --system` is running, `/run/dbus/system_bus_socket` exists
- but `systemctl is-system-running` returns `Failed to connect to bus: Operation not permitted`

Most likely remediation (Windows-side; **do not run inside WSL**):
1) From Windows PowerShell:
   - `wsl --shutdown`
2) Reopen Ubuntu, then re-test in WSL:
   - `systemctl is-system-running`
   - `systemctl status dbus`

## Post-WSL-restart status (2026-01-04)

systemd/dbus (healthy; note: `systemctl` needs unrestricted sandbox here):
```text
$ systemctl is-system-running
running

$ systemctl status dbus --no-pager
● dbus.service - D-Bus System Message Bus
     Loaded: loaded (/usr/lib/systemd/system/dbus.service; static)
     Active: active (running) since Sun 2026-01-04 08:59:48 CST; 25min ago
TriggeredBy: ● dbus.socket
       Docs: man:dbus-daemon(1)
   Main PID: 156 (dbus-daemon)
      Tasks: 1 (limit: 7100)
     Memory: 2.2M (peak: 3.0M)
        CPU: 103ms
     CGroup: /system.slice/dbus.service
             └─156 @dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only

Jan 04 08:59:48 TiffanyLT systemd[1]: Starting dbus.service - D-Bus System Message Bus...
Jan 04 08:59:48 TiffanyLT systemd[1]: Started dbus.service - D-Bus System Message Bus.
Jan 04 08:59:48 TiffanyLT dbus-daemon[156]: [system] Activating via systemd: service name='org.freedesktop.timedate1' unit='dbus-org.freedesktop.timedate1.service' requested by ':1.5' (uid=0 pid=164 comm="/usr/lib/snapd/snapd" label="kernel")
Jan 04 08:59:49 TiffanyLT dbus-daemon[156]: [system] Successfully activated service 'org.freedesktop.timedate1'
```

PATH check (`~/.npm-global/bin`):
```text
match segment 1: /home/xhott/.npm-global/bin
count=1
```

## B1 — Git line endings (WSL-first default)

Change applied:
- `git config --global core.autocrlf input`

Verification:
```text
$ git config --global --get core.autocrlf
input
```

Backups created (timestamped, next to the file):
- `~/.gitconfig.bak-20260104-091354`

Rollback:
- `cp -a ~/.gitconfig.bak-20260104-091354 ~/.gitconfig`
- (or) `git config --global --unset core.autocrlf`

## B2 — SSH key setup (ed25519)

Status:
- `~/.ssh` had no private keys, so a new keypair was generated (no overwrite).
- Generated with an empty passphrase (`ssh-keygen -N ""`). To add one later: `ssh-keygen -p -f ~/.ssh/id_ed25519`

Files created:
- `~/.ssh/id_ed25519`
- `~/.ssh/id_ed25519.pub`

Public key:
```text
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKwbLkysTya99AJD1vPwsIwpOu2NQIzBLHJuOP6mnzi/ xhott@TiffanyLT
```

Add to GitHub:
1) GitHub → Settings → SSH and GPG keys → New SSH key
2) Paste the public key, title it (e.g., `wsl`), save

Add to GitLab:
1) GitLab → Preferences → SSH Keys
2) Paste the public key, title it, save

## B3 — Windows PATH interop (no changes)

Pros:
- Convenient access to Windows tools from WSL (e.g., `powershell.exe`, `code`, Windows Git)

Cons:
- Tool precedence surprises (a Windows binary may override a Linux one)
- Very large `PATH` (slower lookups, noisier debugging)
- Potential cross-filesystem quirks when a Windows tool touches Linux paths (and vice versa)

Quick breakage test (current shell):
```sh
printf '%s\n' "$PATH" | tr ':' '\n' | sed -n '1,120p'
type -a git python node code 2>/dev/null || true
command -v git; git --version
```

Decision lever (later; **do not change yet**): `/etc/wsl.conf` `[interop] appendWindowsPath=false`

## Operator Note — `systemctl` EPERM in Codex runner

- In Codex’s restricted runner, `systemctl` can fail with: `Failed to connect to bus: Operation not permitted` (connect-to-bus blocked).
- Authoritative check = run `systemctl` from an interactive Ubuntu shell.

## Current Baseline Snapshot (2026-01-04)

- systemd/dbus (interactive Ubuntu shell): `systemctl is-system-running` => `running`; `dbus` => `active (running)`
- systemd/dbus (Codex runner): `systemctl is-system-running` / `systemctl status dbus` => `Failed to connect to bus: Operation not permitted`
- codex: `/home/xhott/.npm-global/bin/codex` (`codex-cli 0.77.0`)
- npm: `npm prefix -g`=`/home/xhott/.npm-global`; `npm root -g`=`/home/xhott/.npm-global/lib/node_modules`
- git: `core.autocrlf`=`input`
- ssh: `ssh -T git@github.com` => `Hi ledzepp1109! You've successfully authenticated, but GitHub does not provide shell access.`
- PATH: `.npm-global/bin` appears once (match line `1`)
